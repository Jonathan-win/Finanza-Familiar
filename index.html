<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Familiares</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
            font-family: 'Outfit', sans-serif;
            color: #E2E8F0;
        }

        .bg-decoration-1, .bg-decoration-2 {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
        }
        .bg-decoration-1 {
            top: -200px; right: -200px;
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
        }
        .bg-decoration-2 {
            bottom: -300px; left: -200px;
            width: 800px; height: 800px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
        }

        /* Loading & Notification */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 3000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .loading-overlay.show { opacity: 1; pointer-events: all; }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text { margin-top: 20px; color: #94A3B8; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .notification {
            position: fixed; top: 20px; right: 20px;
            padding: 14px 24px; border-radius: 12px;
            color: white; font-weight: 500; z-index: 2000;
            transform: translateX(400px); transition: transform 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #10B981; }
        .notification.error { background: #EF4444; }
        .notification.info { background: #3B82F6; }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .login-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; padding: 40px;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-logo { font-size: 60px; margin-bottom: 16px; }
        .login-title {
            font-size: 28px; font-weight: 700;
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .login-subtitle { color: #64748B; margin-bottom: 32px; }

        /* Forms */
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-label {
            display: block; font-size: 12px; font-weight: 600;
            color: #94A3B8; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .form-input, .form-select {
            width: 100%; padding: 14px 16px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #E2E8F0; font-size: 16px; font-family: inherit;
            outline: none; transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus { border-color: #8B5CF6; }
        .form-select { cursor: pointer; background: rgba(30, 41, 59, 0.95); }

        .btn {
            padding: 14px 24px; border-radius: 12px; border: none;
            font-size: 16px; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            color: white; width: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }
        .btn-success { background: #10B981; color: white; }
        .btn-danger { background: #EF4444; color: white; }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #E2E8F0; border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-sm { padding: 8px 16px; font-size: 14px; }

        /* App Screen */
        .app-screen { display: none; min-height: 100vh; }
        .app-screen.active { display: block; }

        .app-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 16px 20px; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1200px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 12px;
        }
        .header-user { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 18px;
        }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; }
        .user-role { font-size: 12px; color: #8B5CF6; }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Navigation */
        .app-nav {
            display: flex; justify-content: center; gap: 6px;
            padding: 16px; flex-wrap: wrap;
            background: rgba(15, 23, 42, 0.5);
        }
        .nav-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 10px 16px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; color: #94A3B8;
            font-family: inherit; font-size: 13px; cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .nav-btn.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(6, 182, 212, 0.3));
            border-color: #8B5CF6; color: #E2E8F0;
        }

        /* Main Content */
        .app-main { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 24px; margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px; font-weight: 600; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03);
            border-radius: 16px; padding: 20px;
            border-left: 4px solid;
        }
        .stat-card.green { border-color: #10B981; }
        .stat-card.red { border-color: #EF4444; }
        .stat-card.purple { border-color: #8B5CF6; }
        .stat-card.orange { border-color: #F59E0B; }
        .stat-card.blue { border-color: #3B82F6; }
        .stat-label {
            font-size: 12px; color: #64748B;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .stat-value { font-size: 26px; font-weight: 700; }
        .stat-value.green { color: #10B981; }
        .stat-value.red { color: #EF4444; }
        .stat-value.purple { color: #8B5CF6; }
        .stat-value.orange { color: #F59E0B; }
        .stat-value.blue { color: #3B82F6; }

        /* Month Selector */
        .month-selector {
            display: flex; align-items: center; gap: 16px;
            margin-bottom: 20px; flex-wrap: wrap;
        }
        .month-selector label {
            font-size: 14px; color: #94A3B8;
        }
        .month-selector input[type="month"] {
            padding: 10px 16px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(30, 41, 59, 0.95);
            color: #E2E8F0; font-size: 14px; font-family: inherit;
            outline: none;
        }
        .month-selector input[type="month"]:focus {
            border-color: #8B5CF6;
        }

        /* Monthly Summary */
        .monthly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .monthly-stat {
            background: rgba(255,255,255,0.03);
            border-radius: 12px; padding: 16px;
            text-align: center;
        }
        .monthly-stat-label {
            font-size: 11px; color: #64748B;
            text-transform: uppercase; margin-bottom: 6px;
        }
        .monthly-stat-value {
            font-size: 22px; font-weight: 700;
        }

        /* Section Header */
        .section-header {
            display: flex; align-items: center; gap: 10px;
            margin: 24px 0 16px; padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .section-header h3 {
            font-size: 16px; font-weight: 600;
        }
        .section-header .total {
            margin-left: auto; font-size: 14px; font-weight: 600;
        }

        /* Lists */
        .list { display: flex; flex-direction: column; gap: 10px; }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; background: rgba(255,255,255,0.03);
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        }
        .list-item-left { display: flex; align-items: center; gap: 12px; }
        .list-icon {
            width: 42px; height: 42px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .list-info h4 { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .list-info p { font-size: 12px; color: #64748B; }
        .list-info .user-tag {
            display: inline-block; font-size: 10px;
            background: rgba(139, 92, 246, 0.2); color: #A78BFA;
            padding: 2px 8px; border-radius: 4px; margin-top: 4px;
        }
        .list-item-right { display: flex; align-items: center; gap: 10px; }
        .amount { font-weight: 600; }
        .amount.red { color: #EF4444; }
        .amount.green { color: #10B981; }
        .delete-btn {
            background: none; border: none; font-size: 14px;
            cursor: pointer; opacity: 0.5; transition: opacity 0.2s;
        }
        .delete-btn:hover { opacity: 1; }

        .empty-state {
            text-align: center; padding: 40px; color: #64748B;
        }

        /* Family Summary */
        .family-header {
            text-align: center; padding: 30px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.15));
            border-radius: 20px; margin-bottom: 24px;
        }
        .family-balance { font-size: 48px; font-weight: 800; }
        .family-balance.positive { color: #10B981; }
        .family-balance.negative { color: #EF4444; }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        .member-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px; padding: 20px; text-align: center;
        }
        .member-avatar {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 28px;
            margin: 0 auto 12px;
        }
        .member-name { font-weight: 600; font-size: 18px; margin-bottom: 4px; }
        .member-role { font-size: 12px; color: #8B5CF6; margin-bottom: 16px; }
        .member-stats { text-align: left; }
        .member-stat {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }
        .member-stat:last-child { border-bottom: none; }
        .member-stat .label { color: #64748B; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center;
            z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal {
            background: #1E293B; border-radius: 20px;
            padding: 30px; width: 90%; max-width: 450px;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.show .modal { transform: scale(1); }
        .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .modal-actions .btn { flex: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content { justify-content: center; text-align: center; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-value { font-size: 20px; }
            .family-balance { font-size: 32px; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .list-item-right { width: 100%; justify-content: space-between; }
            .monthly-stat-value { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="bg-decoration-1"></div>
    <div class="bg-decoration-2"></div>

    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Cargando...</p>
    </div>

    <div id="notification" class="notification"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
            <h1 class="login-title">Finanzas Familiares</h1>
            <p class="login-subtitle">Ingresa con tu usuario</p>
            <div class="form-group">
                <label class="form-label">Usuario</label>
                <select id="login-user" class="form-select">
                    <option value="">Cargando...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" id="login-password" class="form-input" placeholder="Tu contrase√±a">
            </div>
            <button id="login-btn" class="btn btn-primary">Ingresar</button>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="app-screen">
        <header class="app-header">
            <div class="header-content">
                <div class="header-user">
                    <div class="user-avatar">üë§</div>
                    <div class="user-info">
                        <span class="user-name" id="display-user">Usuario</span>
                        <span class="user-role" id="display-role">usuario</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="openPasswordModal()">üîê Cambiar Clave</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportToExcel()">üì• Excel</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportToPDF()">üìÑ PDF</button>
                    <button class="btn btn-danger btn-sm" onclick="logout()">Salir</button>
                </div>
            </div>
        </header>

        <nav class="app-nav">
            <button class="nav-btn active" data-tab="resumen">üìä Mi Resumen</button>
            <button class="nav-btn" data-tab="ingresos">üíµ Ingresos</button>
            <button class="nav-btn" data-tab="gastos">üí∏ Gastos</button>
            <button class="nav-btn" data-tab="deudas">üìã Deudas</button>
            <button class="nav-btn" data-tab="familia">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</button>
            <button class="nav-btn" data-tab="admin" id="admin-tab" style="display:none;">‚öôÔ∏è Admin</button>
        </nav>

        <main class="app-main">
            <!-- TAB: RESUMEN -->
            <div id="tab-resumen" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-label">Total Ingresos</div>
                        <div class="stat-value green" id="stat-ingresos">S/ 0.00</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Total Gastos</div>
                        <div class="stat-value red" id="stat-gastos">S/ 0.00</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Debo</div>
                        <div class="stat-value orange" id="stat-debo">S/ 0.00</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">Me Deben</div>
                        <div class="stat-value blue" id="stat-medeben">S/ 0.00</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-label">Balance Total</div>
                        <div class="stat-value purple" id="stat-balance">S/ 0.00</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìÖ Resumen Mensual</div>
                    
                    <div class="month-selector">
                        <label>Seleccionar mes:</label>
                        <input type="month" id="selected-month">
                    </div>

                    <div class="monthly-stats">
                        <div class="monthly-stat">
                            <div class="monthly-stat-label">Ingresos del Mes</div>
                            <div class="monthly-stat-value green" id="month-ingresos">S/ 0.00</div>
                        </div>
                        <div class="monthly-stat">
                            <div class="monthly-stat-label">Gastos del Mes</div>
                            <div class="monthly-stat-value red" id="month-gastos">S/ 0.00</div>
                        </div>
                        <div class="monthly-stat">
                            <div class="monthly-stat-label">Balance del Mes</div>
                            <div class="monthly-stat-value purple" id="month-balance">S/ 0.00</div>
                        </div>
                    </div>

                    <!-- Ingresos del mes -->
                    <div class="section-header">
                        <span>üíµ</span>
                        <h3>Ingresos de <span id="month-name-ingresos">este mes</span></h3>
                        <span class="total green" id="month-ingresos-total">S/ 0.00</span>
                    </div>
                    <div id="month-ingresos-list" class="list">
                        <div class="empty-state">No hay ingresos en este mes</div>
                    </div>

                    <!-- Gastos del mes -->
                    <div class="section-header">
                        <span>üí∏</span>
                        <h3>Gastos de <span id="month-name-gastos">este mes</span></h3>
                        <span class="total red" id="month-gastos-total">S/ 0.00</span>
                    </div>
                    <div id="month-gastos-list" class="list">
                        <div class="empty-state">No hay gastos en este mes</div>
                    </div>
                </div>
            </div>

            <!-- TAB: INGRESOS -->
            <div id="tab-ingresos" class="tab-content">
                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">‚ûï Registrar Ingreso</div>
                        <div class="form-group">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" id="ingreso-desc" class="form-input" placeholder="Ej: Sueldo, Bono, Venta...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto</label>
                            <input type="number" id="ingreso-monto" class="form-input" placeholder="S/ 0.00">
                        </div>
                        <button class="btn btn-success" onclick="addIngreso()" style="width:100%">üíµ Agregar Ingreso</button>
                    </div>
                    <div class="card">
                        <div class="card-title">üí∞ Todos Mis Ingresos</div>
                        <div id="list-ingresos" class="list">
                            <div class="empty-state">No hay ingresos registrados</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: GASTOS -->
            <div id="tab-gastos" class="tab-content">
                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">‚ûï Registrar Gasto</div>
                        <div class="form-group">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" id="gasto-desc" class="form-input" placeholder="¬øEn qu√© gastaste?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto</label>
                            <input type="number" id="gasto-monto" class="form-input" placeholder="S/ 0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categor√≠a</label>
                            <select id="gasto-categoria" class="form-select">
                                <option value="alimentacion">üçΩÔ∏è Alimentaci√≥n</option>
                                <option value="transporte">üöó Transporte</option>
                                <option value="servicios">üí° Servicios</option>
                                <option value="vivienda">üè† Vivienda</option>
                                <option value="salud">üíä Salud</option>
                                <option value="educacion">üìö Educaci√≥n</option>
                                <option value="entretenimiento">üé¨ Entretenimiento</option>
                                <option value="ropa">üëï Ropa</option>
                                <option value="tecnologia">üíª Tecnolog√≠a</option>
                                <option value="otros">üì¶ Otros</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addGasto()" style="width:100%">üí∏ Agregar Gasto</button>
                    </div>
                    <div class="card">
                        <div class="card-title">üìâ Todos Mis Gastos</div>
                        <div id="list-gastos" class="list">
                            <div class="empty-state">No hay gastos registrados</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: DEUDAS -->
            <div id="tab-deudas" class="tab-content">
                <div class="card-grid">
                    <div class="card">
                        <div class="card-title">‚ûï Registrar Deuda</div>
                        <div class="form-group">
                            <label class="form-label">Tipo</label>
                            <select id="deuda-tipo" class="form-select">
                                <option value="debo">üò∞ Yo debo (tengo que pagar)</option>
                                <option value="me_deben">üòä Me deben (tengo que cobrar)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Persona</label>
                            <input type="text" id="deuda-persona" class="form-input" placeholder="¬øA qui√©n o qui√©n te debe?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descripci√≥n</label>
                            <input type="text" id="deuda-desc" class="form-input" placeholder="Motivo de la deuda">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto</label>
                            <input type="number" id="deuda-monto" class="form-input" placeholder="S/ 0.00">
                        </div>
                        <button class="btn btn-primary" onclick="addDeuda()" style="width:100%">üìã Agregar Deuda</button>
                    </div>
                    <div class="card">
                        <div class="card-title">üìã Mis Deudas</div>
                        <div id="list-deudas" class="list">
                            <div class="empty-state">No hay deudas registradas</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: FAMILIA -->
            <div id="tab-familia" class="tab-content">
                <div class="family-header">
                    <p style="color: #94A3B8; margin-bottom: 8px;">Balance Familiar Total</p>
                    <div class="family-balance positive" id="family-balance">S/ 0.00</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-label">Ingresos Familiares</div>
                        <div class="stat-value green" id="family-ingresos">S/ 0.00</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Gastos Familiares</div>
                        <div class="stat-value red" id="family-gastos">S/ 0.00</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Deudas Totales</div>
                        <div class="stat-value orange" id="family-debo">S/ 0.00</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">Por Cobrar</div>
                        <div class="stat-value blue" id="family-medeben">S/ 0.00</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üë• Miembros de la Familia</div>
                    <div id="members-grid" class="members-grid">
                        <div class="empty-state">Cargando miembros...</div>
                    </div>
                </div>
            </div>

            <!-- TAB: ADMIN -->
            <div id="tab-admin" class="tab-content">
                <div class="card">
                    <div class="card-title">‚öôÔ∏è Panel de Administrador</div>
                    <p style="color: #64748B; margin-bottom: 20px;">Solo los administradores pueden ver todos los datos de la familia.</p>
                    
                    <h3 style="margin: 20px 0 10px;">üìä Todos los Gastos</h3>
                    <div id="admin-gastos" class="list"></div>
                    
                    <h3 style="margin: 20px 0 10px;">üíµ Todos los Ingresos</h3>
                    <div id="admin-ingresos" class="list"></div>
                    
                    <h3 style="margin: 20px 0 10px;">üìã Todas las Deudas</h3>
                    <div id="admin-deudas" class="list"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Cambiar Contrase√±a -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üîê Cambiar Contrase√±a</div>
            <div class="form-group">
                <label class="form-label">Contrase√±a Actual</label>
                <input type="password" id="old-password" class="form-input" placeholder="Tu contrase√±a actual">
            </div>
            <div class="form-group">
                <label class="form-label">Nueva Contrase√±a</label>
                <input type="password" id="new-password" class="form-input" placeholder="Tu nueva contrase√±a">
            </div>
            <div class="form-group">
                <label class="form-label">Confirmar Nueva Contrase√±a</label>
                <input type="password" id="confirm-password" class="form-input" placeholder="Repite la nueva contrase√±a">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="changePassword()">Cambiar</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsBo-GGgDNbfYzvGBpNHUmSQW8dEXyqProVkpr_8BAgkbKcE4Kl4acys25mMeUONGspQ/exec';

        const CATEGORIES = {
            alimentacion: { icon: 'üçΩÔ∏è', color: '#FF6B6B' },
            transporte: { icon: 'üöó', color: '#4ECDC4' },
            servicios: { icon: 'üí°', color: '#FF9800' },
            vivienda: { icon: 'üè†', color: '#2ECC71' },
            salud: { icon: 'üíä', color: '#3498DB' },
            educacion: { icon: 'üìö', color: '#F39C12' },
            entretenimiento: { icon: 'üé¨', color: '#9B59B6' },
            ropa: { icon: 'üëï', color: '#E91E63' },
            tecnologia: { icon: 'üíª', color: '#00BCD4' },
            otros: { icon: 'üì¶', color: '#95A5A6' }
        };

        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        let currentUser = null;
        let currentRole = 'usuario';
        let userIngresos = [];
        let userGastos = [];
        let userDeudas = [];
        let familySummary = null;
        let selectedMonth = '';

        // ==================== HELPERS ====================
        function showLoading() { document.getElementById('loading').classList.add('show'); }
        function hideLoading() { document.getElementById('loading').classList.remove('show'); }

        function showNotification(msg, type = 'success') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(amount || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('es-PE', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getMonthName(monthStr) {
            if (!monthStr) return 'este mes';
            const [year, month] = monthStr.split('-');
            return `${MONTHS[parseInt(month) - 1]} ${year}`;
        }

        function getMonthFromDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        async function apiCall(params) {
            const url = new URL(SCRIPT_URL);
            Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
            try {
                const res = await fetch(url.toString());
                return await res.json();
            } catch (e) {
                console.error('API Error:', e);
                return { success: false, error: e.message };
            }
        }

        // ==================== AUTH ====================
        async function loadUsers() {
            const res = await apiCall({ action: 'getUsers' });
            const select = document.getElementById('login-user');
            if (res.success) {
                select.innerHTML = res.users.map(u => `<option value="${u.usuario}">${u.usuario}</option>`).join('');
            }
        }

        async function login() {
            const usuario = document.getElementById('login-user').value;
            const pass = document.getElementById('login-password').value;
            if (!usuario || !pass) return showNotification('Completa todos los campos', 'error');

            showLoading();
            const res = await apiCall({ action: 'login', usuario, contrase√±a: pass });
            hideLoading();

            if (res.success) {
                currentUser = res.usuario;
                currentRole = res.rol || 'usuario';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').classList.add('active');
                document.getElementById('display-user').textContent = currentUser;
                document.getElementById('display-role').textContent = currentRole === 'admin' ? 'üëë Administrador' : 'üë§ Usuario';
                
                if (currentRole === 'admin') {
                    document.getElementById('admin-tab').style.display = 'flex';
                }

                // Set current month
                const now = new Date();
                selectedMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById('selected-month').value = selectedMonth;
                
                await loadAllData();
                showNotification(`¬°Bienvenido, ${currentUser}!`);
            } else {
                showNotification(res.error || 'Error al ingresar', 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentRole = 'usuario';
            document.getElementById('app-screen').classList.remove('active');
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-password').value = '';
            document.getElementById('admin-tab').style.display = 'none';
        }

        // ==================== DATA ====================
        async function loadAllData() {
            showLoading();
            await Promise.all([loadIngresos(), loadGastos(), loadDeudas(), loadFamilySummary()]);
            updateStats();
            updateMonthlyView();
            if (currentRole === 'admin') await loadAdminData();
            hideLoading();
        }

        async function loadIngresos() {
            const res = await apiCall({ action: 'getIngresos', usuario: currentUser });
            userIngresos = res.success ? res.data : [];
            renderIngresos();
        }

        async function loadGastos() {
            const res = await apiCall({ action: 'readUser', usuario: currentUser });
            userGastos = res.success ? res.data.map(r => ({
                id: r.id, fecha: r.fecha, descripcion: r.descripcion,
                monto: parseFloat(r.monto) || 0, categoria: r.categoria
            })) : [];
            renderGastos();
        }

        async function loadDeudas() {
            const res = await apiCall({ action: 'getDeudas', usuario: currentUser });
            userDeudas = res.success ? res.data : [];
            renderDeudas();
        }

        async function loadFamilySummary() {
            const res = await apiCall({ action: 'getFamilySummary' });
            if (res.success) {
                familySummary = res.summary;
                renderFamilySummary();
            }
        }

        async function loadAdminData() {
            const res = await apiCall({ action: 'getAllDataAdmin', usuario: currentUser });
            if (res.success) {
                renderAdminData(res);
            }
        }

        // ==================== STATS ====================
        function updateStats() {
            const totalIngresos = userIngresos.reduce((s, i) => s + (i.monto || 0), 0);
            const totalGastos = userGastos.reduce((s, g) => s + (g.monto || 0), 0);
            const totalDebo = userDeudas.filter(d => d.tipo === 'debo').reduce((s, d) => s + (d.monto || 0), 0);
            const totalMeDeben = userDeudas.filter(d => d.tipo === 'me_deben').reduce((s, d) => s + (d.monto || 0), 0);
            const balance = totalIngresos - totalGastos - totalDebo + totalMeDeben;

            document.getElementById('stat-ingresos').textContent = formatCurrency(totalIngresos);
            document.getElementById('stat-gastos').textContent = formatCurrency(totalGastos);
            document.getElementById('stat-debo').textContent = formatCurrency(totalDebo);
            document.getElementById('stat-medeben').textContent = formatCurrency(totalMeDeben);
            document.getElementById('stat-balance').textContent = formatCurrency(balance);
            document.getElementById('stat-balance').className = `stat-value ${balance >= 0 ? 'purple' : 'red'}`;
        }

        // ==================== MONTHLY VIEW ====================
        function updateMonthlyView() {
            const monthName = getMonthName(selectedMonth);
            document.getElementById('month-name-ingresos').textContent = monthName;
            document.getElementById('month-name-gastos').textContent = monthName;

            // Filter by month
            const monthIngresos = userIngresos.filter(i => getMonthFromDate(i.fecha) === selectedMonth);
            const monthGastos = userGastos.filter(g => getMonthFromDate(g.fecha) === selectedMonth);

            const totalMonthIngresos = monthIngresos.reduce((s, i) => s + (i.monto || 0), 0);
            const totalMonthGastos = monthGastos.reduce((s, g) => s + (g.monto || 0), 0);
            const monthBalance = totalMonthIngresos - totalMonthGastos;

            // Update monthly stats
            document.getElementById('month-ingresos').textContent = formatCurrency(totalMonthIngresos);
            document.getElementById('month-gastos').textContent = formatCurrency(totalMonthGastos);
            document.getElementById('month-balance').textContent = formatCurrency(monthBalance);
            document.getElementById('month-balance').className = `monthly-stat-value ${monthBalance >= 0 ? 'green' : 'red'}`;

            document.getElementById('month-ingresos-total').textContent = formatCurrency(totalMonthIngresos);
            document.getElementById('month-gastos-total').textContent = formatCurrency(totalMonthGastos);

            // Render lists
            const ingresosContainer = document.getElementById('month-ingresos-list');
            if (monthIngresos.length === 0) {
                ingresosContainer.innerHTML = '<div class="empty-state">No hay ingresos en este mes</div>';
            } else {
                ingresosContainer.innerHTML = monthIngresos.map(i => `
                    <div class="list-item">
                        <div class="list-item-left">
                            <div class="list-icon" style="background: rgba(16,185,129,0.2)">üíµ</div>
                            <div class="list-info">
                                <h4>${i.descripcion}</h4>
                                <p>${formatDate(i.fecha)}</p>
                            </div>
                        </div>
                        <div class="list-item-right">
                            <span class="amount green">+${formatCurrency(i.monto)}</span>
                        </div>
                    </div>
                `).join('');
            }

            const gastosContainer = document.getElementById('month-gastos-list');
            if (monthGastos.length === 0) {
                gastosContainer.innerHTML = '<div class="empty-state">No hay gastos en este mes</div>';
            } else {
                gastosContainer.innerHTML = monthGastos.map(g => {
                    const cat = CATEGORIES[g.categoria] || CATEGORIES.otros;
                    return `
                        <div class="list-item">
                            <div class="list-item-left">
                                <div class="list-icon" style="background: ${cat.color}22">${cat.icon}</div>
                                <div class="list-info">
                                    <h4>${g.descripcion}</h4>
                                    <p>${formatDate(g.fecha)}</p>
                                </div>
                            </div>
                            <div class="list-item-right">
                                <span class="amount red">-${formatCurrency(g.monto)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ==================== RENDERS ====================
        function renderIngresos() {
            const container = document.getElementById('list-ingresos');
            if (userIngresos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay ingresos registrados</div>';
                return;
            }
            container.innerHTML = userIngresos.map(i => `
                <div class="list-item">
                    <div class="list-item-left">
                        <div class="list-icon" style="background: rgba(16,185,129,0.2)">üíµ</div>
                        <div class="list-info">
                            <h4>${i.descripcion}</h4>
                            <p>${formatDate(i.fecha)}</p>
                        </div>
                    </div>
                    <div class="list-item-right">
                        <span class="amount green">+${formatCurrency(i.monto)}</span>
                        <button class="delete-btn" onclick="deleteIngreso('${i.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderGastos() {
            const container = document.getElementById('list-gastos');
            if (userGastos.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay gastos registrados</div>';
                return;
            }
            container.innerHTML = userGastos.map(g => {
                const cat = CATEGORIES[g.categoria] || CATEGORIES.otros;
                return `
                    <div class="list-item">
                        <div class="list-item-left">
                            <div class="list-icon" style="background: ${cat.color}22">${cat.icon}</div>
                            <div class="list-info">
                                <h4>${g.descripcion}</h4>
                                <p>${formatDate(g.fecha)}</p>
                            </div>
                        </div>
                        <div class="list-item-right">
                            <span class="amount red">-${formatCurrency(g.monto)}</span>
                            <button class="delete-btn" onclick="deleteGasto('${g.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDeudas() {
            const container = document.getElementById('list-deudas');
            if (userDeudas.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay deudas registradas</div>';
                return;
            }
            container.innerHTML = userDeudas.map(d => {
                const isDebo = d.tipo === 'debo';
                return `
                    <div class="list-item">
                        <div class="list-item-left">
                            <div class="list-icon" style="background: ${isDebo ? 'rgba(249,115,22,0.2)' : 'rgba(59,130,246,0.2)'}">${isDebo ? 'üò∞' : 'üòä'}</div>
                            <div class="list-info">
                                <h4>${d.descripcion}</h4>
                                <p>${isDebo ? 'Debo a' : 'Me debe'}: ${d.persona} ‚Ä¢ ${formatDate(d.fecha)}</p>
                            </div>
                        </div>
                        <div class="list-item-right">
                            <span class="amount ${isDebo ? 'red' : 'green'}">${isDebo ? '-' : '+'}${formatCurrency(d.monto)}</span>
                            <button class="delete-btn" onclick="deleteDeuda('${d.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFamilySummary() {
            if (!familySummary) return;
            const s = familySummary;
            
            document.getElementById('family-balance').textContent = formatCurrency(s.balance);
            document.getElementById('family-balance').className = `family-balance ${s.balance >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('family-ingresos').textContent = formatCurrency(s.totalIngresos);
            document.getElementById('family-gastos').textContent = formatCurrency(s.totalGastos);
            document.getElementById('family-debo').textContent = formatCurrency(s.totalDebo);
            document.getElementById('family-medeben').textContent = formatCurrency(s.totalMeDeben);

            const membersContainer = document.getElementById('members-grid');
            if (s.miembros && s.miembros.length > 0) {
                membersContainer.innerHTML = s.miembros.map(m => `
                    <div class="member-card">
                        <div class="member-avatar">üë§</div>
                        <div class="member-name">${m.usuario}</div>
                        <div class="member-role">${m.rol === 'admin' ? 'üëë Admin' : 'üë§ Usuario'}</div>
                        <div class="member-stats">
                            <div class="member-stat">
                                <span class="label">Ingresos</span>
                                <span class="green">${formatCurrency(m.ingresos)}</span>
                            </div>
                            <div class="member-stat">
                                <span class="label">Gastos</span>
                                <span class="red">${formatCurrency(m.gastos)}</span>
                            </div>
                            <div class="member-stat">
                                <span class="label">Debe</span>
                                <span style="color:#F59E0B">${formatCurrency(m.debo)}</span>
                            </div>
                            <div class="member-stat">
                                <span class="label">Le deben</span>
                                <span style="color:#3B82F6">${formatCurrency(m.meDeben)}</span>
                            </div>
                            <div class="member-stat">
                                <span class="label">Balance</span>
                                <span class="${m.balance >= 0 ? 'green' : 'red'}">${formatCurrency(m.balance)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderAdminData(data) {
            const gastosContainer = document.getElementById('admin-gastos');
            const ingresosContainer = document.getElementById('admin-ingresos');
            const deudasContainer = document.getElementById('admin-deudas');

            gastosContainer.innerHTML = data.gastos.length ? data.gastos.map(g => `
                <div class="list-item">
                    <div class="list-item-left">
                        <div class="list-info">
                            <h4>${g.descripcion}</h4>
                            <p>${formatDate(g.fecha)}</p>
                            <span class="user-tag">üë§ ${g.usuario}</span>
                        </div>
                    </div>
                    <div class="list-item-right">
                        <span class="amount red">-${formatCurrency(g.monto)}</span>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">No hay gastos</div>';

            ingresosContainer.innerHTML = data.ingresos.length ? data.ingresos.map(i => `
                <div class="list-item">
                    <div class="list-item-left">
                        <div class="list-info">
                            <h4>${i.descripcion}</h4>
                            <p>${formatDate(i.fecha)}</p>
                            <span class="user-tag">üë§ ${i.usuario}</span>
                        </div>
                    </div>
                    <div class="list-item-right">
                        <span class="amount green">+${formatCurrency(i.monto)}</span>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">No hay ingresos</div>';

            deudasContainer.innerHTML = data.deudas.length ? data.deudas.map(d => `
                <div class="list-item">
                    <div class="list-item-left">
                        <div class="list-info">
                            <h4>${d.descripcion}</h4>
                            <p>${d.tipo === 'debo' ? 'Debe a' : 'Le debe'}: ${d.persona}</p>
                            <span class="user-tag">üë§ ${d.usuario}</span>
                        </div>
                    </div>
                    <div class="list-item-right">
                        <span class="amount ${d.tipo === 'debo' ? 'red' : 'green'}">${formatCurrency(d.monto)}</span>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">No hay deudas</div>';
        }

        // ==================== ACTIONS ====================
        async function addIngreso() {
            const desc = document.getElementById('ingreso-desc').value;
            const monto = parseFloat(document.getElementById('ingreso-monto').value);
            if (!desc || !monto) return showNotification('Completa todos los campos', 'error');

            showLoading();
            const res = await apiCall({ action: 'addIngreso', descripcion: desc, monto, usuario: currentUser, fecha: new Date().toISOString() });
            hideLoading();

            if (res.success) {
                document.getElementById('ingreso-desc').value = '';
                document.getElementById('ingreso-monto').value = '';
                await loadAllData();
                showNotification('Ingreso registrado');
            } else {
                showNotification(res.error || 'Error', 'error');
            }
        }

        async function addGasto() {
            const desc = document.getElementById('gasto-desc').value;
            const monto = parseFloat(document.getElementById('gasto-monto').value);
            const cat = document.getElementById('gasto-categoria').value;
            if (!desc || !monto) return showNotification('Completa todos los campos', 'error');

            showLoading();
            const res = await apiCall({ action: 'write', descripcion: desc, monto, categoria: cat, tipo: 'variable', usuario: currentUser, fecha: new Date().toISOString() });
            hideLoading();

            if (res.success) {
                document.getElementById('gasto-desc').value = '';
                document.getElementById('gasto-monto').value = '';
                await loadAllData();
                showNotification('Gasto registrado');
            } else {
                showNotification(res.error || 'Error', 'error');
            }
        }

        async function addDeuda() {
            const tipo = document.getElementById('deuda-tipo').value;
            const persona = document.getElementById('deuda-persona').value;
            const desc = document.getElementById('deuda-desc').value;
            const monto = parseFloat(document.getElementById('deuda-monto').value);
            if (!persona || !desc || !monto) return showNotification('Completa todos los campos', 'error');

            showLoading();
            const res = await apiCall({ action: 'addDeuda', tipo, persona, descripcion: desc, monto, usuario: currentUser, fecha: new Date().toISOString() });
            hideLoading();

            if (res.success) {
                document.getElementById('deuda-persona').value = '';
                document.getElementById('deuda-desc').value = '';
                document.getElementById('deuda-monto').value = '';
                await loadAllData();
                showNotification('Deuda registrada');
            } else {
                showNotification(res.error || 'Error', 'error');
            }
        }

        async function deleteIngreso(id) {
            if (!confirm('¬øEliminar este ingreso?')) return;
            showLoading();
            const res = await apiCall({ action: 'deleteIngreso', id });
            hideLoading();
            if (res.success) { await loadAllData(); showNotification('Eliminado', 'info'); }
            else showNotification('Error al eliminar', 'error');
        }

        async function deleteGasto(id) {
            if (!confirm('¬øEliminar este gasto?')) return;
            showLoading();
            const res = await apiCall({ action: 'delete', id });
            hideLoading();
            if (res.success) { await loadAllData(); showNotification('Eliminado', 'info'); }
            else showNotification('Error al eliminar', 'error');
        }

        async function deleteDeuda(id) {
            if (!confirm('¬øEliminar esta deuda?')) return;
            showLoading();
            const res = await apiCall({ action: 'deleteDeuda', id });
            hideLoading();
            if (res.success) { await loadAllData(); showNotification('Eliminado', 'info'); }
            else showNotification('Error al eliminar', 'error');
        }

        // ==================== PASSWORD ====================
        function openPasswordModal() { document.getElementById('password-modal').classList.add('show'); }
        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('show');
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }

        async function changePassword() {
            const oldPass = document.getElementById('old-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (!oldPass || !newPass || !confirmPass) return showNotification('Completa todos los campos', 'error');
            if (newPass !== confirmPass) return showNotification('Las contrase√±as no coinciden', 'error');
            if (newPass.length < 4) return showNotification('La contrase√±a debe tener al menos 4 caracteres', 'error');

            showLoading();
            const res = await apiCall({ action: 'changePassword', usuario: currentUser, oldPass, newPass });
            hideLoading();

            if (res.success) {
                closePasswordModal();
                showNotification('Contrase√±a cambiada exitosamente');
            } else {
                showNotification(res.error || 'Error al cambiar contrase√±a', 'error');
            }
        }

        // ==================== EXPORT ====================
        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            const ingresosData = [['Fecha', 'Descripci√≥n', 'Monto']];
            userIngresos.forEach(i => ingresosData.push([formatDate(i.fecha), i.descripcion, i.monto]));
            const wsIngresos = XLSX.utils.aoa_to_sheet(ingresosData);
            XLSX.utils.book_append_sheet(wb, wsIngresos, 'Ingresos');

            const gastosData = [['Fecha', 'Descripci√≥n', 'Categor√≠a', 'Monto']];
            userGastos.forEach(g => gastosData.push([formatDate(g.fecha), g.descripcion, g.categoria, g.monto]));
            const wsGastos = XLSX.utils.aoa_to_sheet(gastosData);
            XLSX.utils.book_append_sheet(wb, wsGastos, 'Gastos');

            const deudasData = [['Fecha', 'Tipo', 'Persona', 'Descripci√≥n', 'Monto']];
            userDeudas.forEach(d => deudasData.push([formatDate(d.fecha), d.tipo === 'debo' ? 'Debo' : 'Me deben', d.persona, d.descripcion, d.monto]));
            const wsDeudas = XLSX.utils.aoa_to_sheet(deudasData);
            XLSX.utils.book_append_sheet(wb, wsDeudas, 'Deudas');

            XLSX.writeFile(wb, `Finanzas_${currentUser}_${new Date().toISOString().slice(0,10)}.xlsx`);
            showNotification('Excel descargado');
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const totalIngresos = userIngresos.reduce((s, i) => s + (i.monto || 0), 0);
            const totalGastos = userGastos.reduce((s, g) => s + (g.monto || 0), 0);
            const totalDebo = userDeudas.filter(d => d.tipo === 'debo').reduce((s, d) => s + (d.monto || 0), 0);
            const totalMeDeben = userDeudas.filter(d => d.tipo === 'me_deben').reduce((s, d) => s + (d.monto || 0), 0);
            const balance = totalIngresos - totalGastos - totalDebo + totalMeDeben;

            doc.setFontSize(20);
            doc.text('Finanzas Familiares', 20, 20);
            
            doc.setFontSize(14);
            doc.text(`Usuario: ${currentUser}`, 20, 35);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-PE')}`, 20, 45);

            doc.setFontSize(16);
            doc.text('Resumen', 20, 60);
            
            doc.setFontSize(12);
            doc.text(`Ingresos: ${formatCurrency(totalIngresos)}`, 20, 75);
            doc.text(`Gastos: ${formatCurrency(totalGastos)}`, 20, 85);
            doc.text(`Debo: ${formatCurrency(totalDebo)}`, 20, 95);
            doc.text(`Me deben: ${formatCurrency(totalMeDeben)}`, 20, 105);
            doc.text(`Balance: ${formatCurrency(balance)}`, 20, 120);

            let y = 140;
            doc.setFontSize(14);
            doc.text('Ultimos Ingresos', 20, y);
            y += 10;
            doc.setFontSize(10);
            userIngresos.slice(0, 5).forEach(i => {
                doc.text(`${formatDate(i.fecha)} - ${i.descripcion}: ${formatCurrency(i.monto)}`, 20, y);
                y += 8;
            });

            y += 10;
            doc.setFontSize(14);
            doc.text('Ultimos Gastos', 20, y);
            y += 10;
            doc.setFontSize(10);
            userGastos.slice(0, 5).forEach(g => {
                doc.text(`${formatDate(g.fecha)} - ${g.descripcion}: ${formatCurrency(g.monto)}`, 20, y);
                y += 8;
            });

            doc.save(`Finanzas_${currentUser}_${new Date().toISOString().slice(0,10)}.pdf`);
            showNotification('PDF descargado');
        }

        // ==================== NAVIGATION ====================
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
            });
        });

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUsers();
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('login-password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
            
            // Month selector change event
            document.getElementById('selected-month').addEventListener('change', (e) => {
                selectedMonth = e.target.value;
                updateMonthlyView();
            });
        });
    </script>
</body>
</html>
